-- RCP BMW Servie 0x22 Script
-- Version, 5.2.0
-- Copyright (c) 2023 The SECRET Ingredient!
-- GNU General Public License v3.0
--
-- Select BMW OBD Service 0x22 PID Maps Available at
-- https://thesecretingredient.neocities.org
--
local a=13.5;local b=0X6F1;local c=0x0FF;local d=0x600;local e=0xF00;local f=0;local g=100;local h=2;local i=false;local j=true;setTickRate(1000)local k,l,m=0,0,0;local n=0;setCANfilter(f,0,0,d,e)for o,p in pairs(gc_list)do p[12]=addChannel(string.sub(p[2],1,11),unpack(p,3,6),string.sub(p[7],1,7))p[13],p[14],p[15],p[16],p[17]=0,0,0,0,0;k=math.max(k,p[3])end;function _sQ()local o=_gQ()if o~=nil then if _sM(b,{gc_list[o][1],0x03,0x22,bit.band(bit.rshift(o,8),0xFF),bit.band(o,0xFF)})==1 then l=getUptime()gc_list[o][14]=gc_list[o][14]+1;_rR()end end end;function _gQ()if getUptime()-l>g then if getUptime()-h>m then local q,r,s=nil,0,0;for o,p in pairs(gc_list)do p[13]=p[13]+p[3]r=p[13]/p[3]if p[13]>k and r>s then q,s=o,r end end;if q~=nil then gc_list[q][13]=0;return q end end end end;function _sM(t,u)if txCAN(f,t,0,u,g)==1 then if i==true then _lD(f,t,u)end;return 1 end end;function _rR()local t,u=_rM()if t~=nil and l~=0 and bit.band(b,c)==u[1]and u[3]==0x62 then if _pD(t,u)==1 then l=0;m=getUptime()end end end;function _rM(v)local t,w,u=rxCAN(f,g)if t~=nil then if i==true then _lD(f,t,u)end;if bit.band(u[2],0xF0)==0x00 then return t,u else if bit.band(u[2],0xF0)==0x10 then local x={u[1],unpack(u,3)}local y=math.ceil((bit.lshift(bit.band(u[2],0x0F),8)+u[3]-(#u-3))/6)u={bit.band(t,c),0x30,y,h}if _sM(b,u)==1 then if v==nil then v=0 end;repeat v=v+1;t,u=_rM(v)if t~=nil then for z=1,#u do x[#x+1]=u[z]end;if v>=y then return t,x end end until t==nil end elseif bit.band(u[2],0xF0)==0x20 and bit.band(u[2],0x0F)==bit.band(v,0x0F)then return t,{unpack(u,3)}else u={bit.band(t,c),0x32,0x00,0x00}_sM(f,b,u)end end end end;function _rM(v)local t,w,u=rxCAN(f,g)if t~=nil then if i==true then _lD(f,t,u)end;if bit.band(u[2],0xF0)==0x00 then return t,u else if bit.band(u[2],0xF0)==0x10 then local x={u[1],unpack(u,3)}local y=math.ceil((bit.lshift(bit.band(u[2],0x0F),8)+u[3]-(#u-3))/6)u={bit.band(t,c),0x30,y,h}if _sM(b,u)==1 then if v==nil then v=0 end;repeat v=v+1;t,u=_rM(v)if t~=nil then for z=1,#u do x[#x+1]=u[z]end;if v>=y then return t,x end end until t==nil end elseif bit.band(u[2],0xF0)==0x20 and bit.band(u[2],0x0F)==bit.band(v,0x0F)then return t,{unpack(u,3)}else u={bit.band(t,c),0x32,0x00,0x00}_sM(f,b,u)end end end end;function _pD(t,u)local o=bit.lshift(u[4],8)+u[5]if gc_list[o]then if bit.band(t,c)==gc_list[o][1]then local A=0;for z=6,u[2]+2 do A=A+bit.lshift(u[z],8*(u[2]+2-z))end;if gc_list[o][8]=='s'then A=_sI(A,u[2]-3)end;if gc_list[o][5]~=nil then A=math.max(A,gc_list[o][5])end;if gc_list[o][6]~=nil then A=math.min(A,gc_list[o][6])end;setChannel(gc_list[o][12],A*gc_list[o][9]/gc_list[o][10]+gc_list[o][11])if j==true then local B=getUptime()gc_list[o][16]=gc_list[o][15]~=0 and(gc_list[o][14]*gc_list[o][16]+B-gc_list[o][15])/(gc_list[o][14]+1)or 0;gc_list[o][17]=gc_list[o][15]~=0 and(gc_list[o][14]*gc_list[o][17]+B-l)/(gc_list[o][14]+1)or 0;println(string.format("[0x%04X] - TS:[%d] QC:[%d] LU:[%d] AR:[%d] AL:[%d]",o,B,unpack(gc_list[o],14)))gc_list[o][15]=B end;return 1 end end end;function _sI(u,C)return u>=math.pow(2,C*8-1)and u-math.pow(2,C*8)or u end;function _lD(D,t,u)local E,F,G,H,I,J,K=getDateTime()local L=string.format("%04d-%02d-%02d %02d:%02d:%02d.%03d %9d",E,F,G,H,I,J,K,getUptime())L=L..string.format(" %1d %4d 0x%03X %02d",D+1,t,t,#u)L=L..string.format(string.rep(" 0x%02X",#u),unpack(u))println(L)end
function onTick()if getUptime()-n>=1000 then collectgarbage()n=getUptime()end;if getChannel("Battery")~=nil and getChannel("Battery")>=a then _sQ()end end
